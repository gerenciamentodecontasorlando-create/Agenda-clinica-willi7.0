<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="theme-color" content="#2a63ff" />
  <link rel="manifest" href="manifest.json" />
  <link rel="icon" href="icons/icon.svg" type="image/svg+xml" />
  <link rel="apple-touch-icon" href="icons/icon-192.png" />
  <title>BTX Docs ‚Ä¢ PWA</title>

  <style>
    :root{
      --bg:#f6f8fb;
      --card:#ffffff;
      --text:#0b1220;
      --muted:#5a6b84;
      --line:#d6deea;
      --accent:#2a63ff;
      --accent2:#00c2ff;
      --ok:#16a34a;
      --warn:#f59e0b;
      --bad:#ef4444;
      --shadow: 0 10px 30px rgba(11,18,32,.08);
      --radius: 18px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: var(--sans);
      background: radial-gradient(1200px 800px at 20% 0%, rgba(42,99,255,.10), transparent 55%),
                  radial-gradient(900px 700px at 80% 0%, rgba(0,194,255,.10), transparent 55%),
                  var(--bg);
      color:var(--text);
    }
    .wrap{max-width:1200px;margin:0 auto;padding:18px}
    .topbar{
      display:flex; gap:12px; align-items:center; justify-content:space-between;
      padding:14px 16px; border:1px solid var(--line); background:rgba(255,255,255,.75);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      box-shadow: var(--shadow);
      position:sticky; top:10px; z-index:20;
    }
    .brand{display:flex; gap:12px; align-items:center;}
    .logo{
      width:42px;height:42px;border-radius:14px;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      box-shadow: 0 12px 22px rgba(42,99,255,.25);
      position:relative;
    }
    .logo:after{content:""; position:absolute; inset:9px; border-radius:10px; border:1px solid rgba(255,255,255,.55);}
    .brand h1{font-size:14px;margin:0;line-height:1.1}
    .brand p{margin:0;color:var(--muted);font-size:12px}
    .actions{display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end}
    button, .btn{
      border:1px solid var(--line);
      background: #fff;
      color:var(--text);
      padding:10px 12px;
      border-radius: 14px;
      cursor:pointer;
      box-shadow: 0 8px 18px rgba(11,18,32,.06);
      font-weight: 600;
      font-size: 12px;
      transition:.15s transform, .15s box-shadow, .15s border-color;
      display:inline-flex; align-items:center; gap:8px;
      user-select:none;
    }
    button:hover{transform: translateY(-1px); box-shadow: 0 14px 24px rgba(11,18,32,.09); border-color:#c7d2e4;}
    button.primary{
      border-color: rgba(42,99,255,.35);
      background: linear-gradient(135deg, rgba(42,99,255,.12), rgba(0,194,255,.10));
    }
    button.danger{border-color: rgba(239,68,68,.35); background: rgba(239,68,68,.06);}
    button.ok{border-color: rgba(22,163,74,.35); background: rgba(22,163,74,.06);}
    .grid{
      display:grid;
      grid-template-columns: 320px 1fr;
      gap:14px;
      margin-top:14px;
    }
    @media (max-width: 980px){
      .grid{grid-template-columns: 1fr;}
      .topbar{position:relative; top:0}
    }
    .side, .main{
      background:rgba(255,255,255,.70);
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .panelHead{
      padding:14px 14px 10px 14px;
      border-bottom:1px solid var(--line);
      background: linear-gradient(180deg, rgba(42,99,255,.06), transparent);
    }
    .panelHead h2{margin:0; font-size:13px; letter-spacing:.2px;}
    .panelHead p{margin:6px 0 0 0; font-size:12px; color:var(--muted)}
    .panelBody{padding:12px 14px 14px 14px}
    .tabs{
      display:flex; gap:8px; flex-wrap:wrap;
      padding:10px 12px;
      border-bottom:1px solid var(--line);
      background: rgba(255,255,255,.65);
    }
    .tab{
      padding:9px 10px;
      border-radius: 14px;
      border:1px solid var(--line);
      background:#fff;
      cursor:pointer;
      font-size:12px;
      font-weight:700;
      color:var(--muted);
      display:inline-flex; gap:8px; align-items:center;
    }
    .tab.active{
      color:var(--text);
      border-color: rgba(42,99,255,.35);
      background: linear-gradient(135deg, rgba(42,99,255,.12), rgba(0,194,255,.10));
    }
    .row{display:grid; grid-template-columns: 1fr 1fr; gap:10px}
    @media (max-width: 700px){ .row{grid-template-columns: 1fr;} }
    label{display:block; font-size:11px; color:var(--muted); margin:0 0 6px 2px; font-weight:700}
    input, select, textarea{
      width:100%;
      padding:10px 11px;
      border:1px solid var(--line);
      border-radius: 14px;
      outline:none;
      background:#fff;
      color:var(--text);
      font-size:13px;
      box-shadow: 0 8px 16px rgba(11,18,32,.05) inset;
    }
    textarea{min-height: 92px; resize: vertical; line-height:1.35}
    input:focus, select:focus, textarea:focus{
      border-color: rgba(42,99,255,.55);
      box-shadow: 0 0 0 4px rgba(42,99,255,.12);
    }
    .hint{font-size:11px; color:var(--muted); margin-top:6px; line-height:1.25}
    .mini{display:flex; gap:8px; align-items:center; flex-wrap:wrap;}
    .chip{
      padding:6px 10px;
      border-radius: 999px;
      border:1px solid var(--line);
      background:#fff;
      font-size:11px;
      color:var(--muted);
      font-weight:800;
    }
    .chip.ok{border-color: rgba(22,163,74,.35); background: rgba(22,163,74,.08); color:#126b33}
    .chip.warn{border-color: rgba(245,158,11,.35); background: rgba(245,158,11,.10); color:#8a5a04}
    .chip.bad{border-color: rgba(239,68,68,.35); background: rgba(239,68,68,.10); color:#8b1f1f}
    .list{display:flex; flex-direction:column; gap:10px;}
    .card{
      background:#fff;
      border:1px solid var(--line);
      border-radius: 16px;
      padding:12px;
      box-shadow: 0 10px 22px rgba(11,18,32,.06);
    }
    .card h3{margin:0 0 6px 0; font-size:13px}
    .card p{margin:0; font-size:12px; color:var(--muted); line-height:1.25}
    .split{display:grid; grid-template-columns: 1fr 1fr; gap:10px;}
    @media (max-width: 850px){ .split{grid-template-columns: 1fr;} }
    .hr{height:1px;background:var(--line);margin:12px 0}
    .rightTools{display:flex; gap:8px; flex-wrap:wrap; margin-top:10px;}
    .kbd{
      font-family: var(--mono);
      font-size: 11px;
      padding:3px 6px;
      border:1px solid var(--line);
      border-bottom-width:2px;
      border-radius: 8px;
      background:#fff;
      color:var(--muted);
      font-weight:800;
    }
    .small{font-size:11px;color:var(--muted)}
    .titleLine{display:flex; align-items:flex-end; justify-content:space-between; gap:10px;}
    .titleLine h2{margin:0;font-size:14px}
    .empty{
      padding:16px;
      border:1px dashed var(--line);
      border-radius: 16px;
      background: rgba(255,255,255,.6);
      color:var(--muted);
      font-size:12px;
      line-height:1.25;
    }

    /* ======= Calendar (Agenda) ======= */
    .calWrap{
      border:1px solid var(--line);
      background:#fff;
      border-radius: 16px;
      box-shadow: 0 10px 22px rgba(11,18,32,.06);
      overflow:hidden;
    }
    .calHead{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:10px 10px;
      border-bottom:1px solid var(--line);
      background: linear-gradient(135deg, rgba(42,99,255,.08), rgba(0,194,255,.06));
    }
    .calHead strong{font-size:12px}
    .calGrid{
      display:grid;
      grid-template-columns: repeat(7, 1fr);
      gap:0;
      padding:10px;
    }
    .dow{
      font-size:10px;
      color:var(--muted);
      font-weight:900;
      text-align:center;
      padding:6px 0;
    }
    .day{
      position:relative;
      height:44px;
      border-radius: 12px;
      margin:2px;
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      font-weight:900;
      color:#0b1220;
      border:1px solid transparent;
      user-select:none;
    }
    .day:hover{border-color: rgba(42,99,255,.25); background: rgba(42,99,255,.06);}
    .day.muted{color:#9aa7bb; font-weight:800;}
    .day.today{border-color: rgba(42,99,255,.55); background: rgba(42,99,255,.10);}
    .day.selected{border-color: rgba(0,194,255,.65); background: rgba(0,194,255,.12);}
    .dot{
      position:absolute; bottom:6px; left:50%; transform:translateX(-50%);
      width:18px; height:6px; border-radius: 99px;
      background: rgba(22,163,74,.20);
      border:1px solid rgba(22,163,74,.35);
    }
    .dot.warn{background: rgba(245,158,11,.18); border-color: rgba(245,158,11,.35);}
    .dot.bad{background: rgba(239,68,68,.16); border-color: rgba(239,68,68,.35);}

    /* ---------- PRINT / DOCUMENT TEMPLATE ---------- */
    .printOverlay{
      position:fixed; inset:0; background: rgba(11,18,32,.55);
      display:none; align-items:center; justify-content:center; padding:18px;
      z-index:50;
    }
    .printOverlay.show{display:flex}
    .printShell{
      width:min(920px, 98vw);
      height:min(92vh, 980px);
      background:#fff;
      border-radius: 18px;
      overflow:hidden;
      box-shadow: 0 30px 70px rgba(0,0,0,.35);
      display:flex; flex-direction:column;
    }
    .printTop{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:12px 12px;
      border-bottom:1px solid var(--line);
      background: linear-gradient(135deg, rgba(42,99,255,.10), rgba(0,194,255,.08));
    }
    .printTop strong{font-size:12px}
    .printTop .muted{font-size:11px}
    .printBody{
      padding:16px;
      overflow:auto;
      background: #f3f6fb;
    }
    .docPage{
      width: 794px;
      min-height: 1123px;
      margin: 0 auto;
      background:#fff;
      border-radius: 14px;
      border: 2px solid #111827;
      box-shadow: 0 12px 30px rgba(11,18,32,.12);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      position:relative;
    }
    .docHeader{
      padding:14px 16px 10px 16px;
      border-bottom: 1px solid #111827;
      background: linear-gradient(180deg, rgba(42,99,255,.09), rgba(0,194,255,.06));
    }
    .docHeader .topRow{display:flex; justify-content:space-between; gap:12px; align-items:flex-start;}
    .docHeader .dent{font-weight:900; font-size:14px; letter-spacing:.2px;}
    .docHeader .dent small{display:block; font-weight:700; color:#334155; margin-top:4px; font-size:11px;}
    .docHeader .stamp{
      font-family: var(--mono);
      font-size: 11px;
      border:1px solid rgba(17,24,39,.35);
      padding:6px 10px;
      border-radius: 12px;
      color:#0b1220;
      background: rgba(255,255,255,.75);
      text-align:right;
      min-width: 220px;
    }
    .docHeader .pat{
      margin-top:10px;
      padding:10px 12px;
      border-radius: 12px;
      border:1px solid rgba(17,24,39,.25);
      background: rgba(255,255,255,.8);
      display:grid;
      grid-template-columns: 1.4fr .9fr .9fr;
      gap:10px;
      font-size:12px;
    }
    .docHeader .pat div b{display:block; font-size:11px; color:#334155}
    .docMain{padding:16px; flex:1;}
    .docMain h3{margin:0 0 10px 0; font-size:16px; letter-spacing:.3px;}
    .docMain .block{border:1px solid rgba(17,24,39,.22); border-radius: 12px; padding:12px; margin: 10px 0;}
    .docMain .block h4{margin:0 0 8px 0; font-size:12px; color:#0b1220}
    .docMain .block p{margin:0; font-size:12px; color:#0b1220; line-height:1.35; white-space:pre-wrap}
    .docFooter{
      padding:12px 16px;
      border-top: 1px solid #111827;
      background: rgba(248,250,252,.9);
    }
    .docFooter .footGrid{display:grid; grid-template-columns: 1.4fr .6fr; gap:12px; align-items:end;}
    .docFooter .addr{font-size:11px; color:#0b1220; line-height:1.25;}
    .sig{text-align:right; font-size:11px; color:#0b1220;}
    .sig .line{height:1px; background:#0b1220; margin:18px 0 6px 0;}

    @media print{
      body{background:#fff}
      .topbar,.side,.tabs,.main .panelHead,.main .panelBody:not(.printable), .printOverlay{display:none !important;}
      .printArea{display:block !important;}
      .docPage{width:auto; min-height:auto; border-radius:0; box-shadow:none; page-break-after: always;}
      @page{size:A4; margin:10mm;}
    }
    .printArea{display:none;}
    .toast{
      position:fixed; right:14px; bottom:14px;
      background:#0b1220; color:#fff;
      padding:10px 12px; border-radius: 14px;
      box-shadow: 0 20px 50px rgba(0,0,0,.25);
      font-size:12px; display:none; z-index:60;
      max-width: min(420px, 92vw);
    }
    .toast.show{display:block}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>BTX Docs ‚Ä¢ PWA</h1>
          <p>Agenda com calend√°rio + documentos cl√≠nicos offline</p>
        </div>
      </div>
      <div class="actions">
        <button class="primary" id="btnInstall" style="display:none">‚¨áÔ∏è Instalar</button>
        <button class="primary" id="btnBackup">üì¶ Exportar backup</button>
        <label class="btn" style="cursor:pointer">
          üì• Importar backup
          <input type="file" id="backupFile" accept="application/json" style="display:none">
        </label>
        <button class="ok" id="btnQuickPrint">üñ®Ô∏è Imprimir/Salvar PDF</button>
        <button class="danger" id="btnReset">üß® Zerar tudo</button>
      </div>
    </div>

    <div class="grid">
      <!-- LEFT -->
      <aside class="side">
        <div class="panelHead">
          <h2>Configura√ß√£o do profissional</h2>
          <p>Esses dados v√£o para todos os documentos.</p>
        </div>
        <div class="panelBody">
          <div class="row">
            <div>
              <label>Nome do dentista</label>
              <input id="dentName" placeholder="Ex.: Dr. Orlando Abreu" />
            </div>
            <div>
              <label>Registro (CRO/UF)</label>
              <input id="dentReg" placeholder="Ex.: CRO-PA 00000" />
            </div>
          </div>

          <div class="row" style="margin-top:10px">
            <div>
              <label>Telefone/WhatsApp</label>
              <input id="dentPhone" placeholder="(xx) xxxxx-xxxx" />
            </div>
            <div>
              <label>E-mail</label>
              <input id="dentEmail" placeholder="seuemail@..." />
            </div>
          </div>

          <div style="margin-top:10px">
            <label>Endere√ßo (rodap√© do documento)</label>
            <textarea id="dentAddr" placeholder="Rua, n¬∫, bairro, cidade/UF, CEP."></textarea>
          </div>

          <div class="hr"></div>

          <div class="titleLine">
            <h2>Receitu√°rio inteligente</h2>
            <p class="small">Biblioteca de medicamentos</p>
          </div>
          <div class="row" style="margin-top:10px">
            <div>
              <label>Medicamento (nome)</label>
              <input id="medName" placeholder="Ex.: Amoxicilina 500mg" />
            </div>
            <div>
              <label>Forma / via</label>
              <input id="medForm" placeholder="Ex.: c√°psula VO" />
            </div>
          </div>
          <div style="margin-top:10px">
            <label>Posologia padr√£o</label>
            <input id="medDose" placeholder="Ex.: 1 c√°psula 8/8h por 7 dias" />
          </div>
          <div style="margin-top:10px">
            <label>Orienta√ß√µes (opcional)</label>
            <textarea id="medNotes" placeholder="Ex.: tomar ap√≥s alimenta√ß√£o; evitar √°lcool; etc."></textarea>
          </div>
          <div class="rightTools">
            <button class="primary" id="btnAddMed">‚ûï Salvar medicamento</button>
            <button id="btnClearMed">üßº Limpar campos</button>
          </div>

          <div class="hr"></div>

          <div class="titleLine">
            <h2>Pacientes</h2>
            <p class="small">Mem√≥ria r√°pida</p>
          </div>

          <div class="row" style="margin-top:10px">
            <div>
              <label>Nome do paciente</label>
              <input id="patName" placeholder="Ex.: Maria Silva" list="patientsList" />
              <datalist id="patientsList"></datalist>
            </div>
            <div>
              <label>CPF/Doc (opcional)</label>
              <input id="patDoc" placeholder="CPF / RG" />
            </div>
          </div>

          <div class="row" style="margin-top:10px">
            <div>
              <label>Data de nascimento (opcional)</label>
              <input id="patBirth" type="date" />
            </div>
            <div>
              <label>Telefone (opcional)</label>
              <input id="patPhone" placeholder="(xx) xxxxx-xxxx" />
            </div>
          </div>

          <div style="margin-top:10px">
            <label>Observa√ß√µes do paciente</label>
            <textarea id="patNotes" placeholder="Alergias, condi√ß√µes, avisos r√°pidos..."></textarea>
          </div>

          <div class="rightTools">
            <button class="primary" id="btnSavePatient">üíæ Salvar/Atualizar paciente</button>
            <button id="btnClearPatient">üßº Limpar</button>
          </div>
        </div>
      </aside>

      <!-- RIGHT -->
      <main class="main">
        <div class="tabs" id="tabs">
          <div class="tab active" data-tab="agenda">üìÖ Agenda</div>
          <div class="tab" data-tab="receita">üíä Receitu√°rio</div>
          <div class="tab" data-tab="ficha">üßæ Ficha cl√≠nica</div>
          <div class="tab" data-tab="atestado">ü©∫ Atestado</div>
          <div class="tab" data-tab="orcamento">üí∞ Or√ßamento</div>
        </div>

        <div class="panelHead">
          <div class="titleLine">
            <h2 id="viewTitle">Agenda</h2>
            <p class="small" id="viewSub">Calend√°rio mensal + lista + mem√≥ria</p>
          </div>
        </div>

        <div class="panelBody">
          <!-- AGENDA -->
          <section id="tab-agenda">
            <div class="split">

              <div>
                <!-- CALENDAR -->
                <div class="calWrap">
                  <div class="calHead">
                    <button id="calPrev">‚óÄ</button>
                    <div style="text-align:center;flex:1">
                      <strong id="calTitle">M√™s</strong>
                      <div class="small" id="calSubtitle">Clique num dia pra filtrar</div>
                    </div>
                    <button id="calNext">‚ñ∂</button>
                    <button class="primary" id="calToday">Hoje</button>
                  </div>

                  <div class="calGrid" id="calDow"></div>
                  <div class="calGrid" id="calDays"></div>
                </div>

                <div class="card" style="margin-top:10px">
                  <h3>Novo agendamento</h3>
                  <p>Selecione um dia no calend√°rio e pronto.</p>

                  <div class="row" style="margin-top:10px">
                    <div>
                      <label>Data</label>
                      <input id="agDate" type="date" />
                    </div>
                    <div>
                      <label>Hora</label>
                      <input id="agTime" type="time" />
                    </div>
                  </div>

                  <div class="row" style="margin-top:10px">
                    <div>
                      <label>Paciente</label>
                      <input id="agPatient" placeholder="Digite e selecione" list="patientsList" />
                    </div>
                    <div>
                      <label>Status</label>
                      <select id="agStatus">
                        <option value="Confirmado">Confirmado</option>
                        <option value="Pendente">Pendente</option>
                        <option value="Faltou">Faltou</option>
                        <option value="Atendido">Atendido</option>
                        <option value="Remarcado">Remarcado</option>
                      </select>
                    </div>
                  </div>

                  <div style="margin-top:10px">
                    <label>Motivo / Observa√ß√µes</label>
                    <textarea id="agNotes" placeholder="Ex.: dor, retorno, limpeza, canal..."></textarea>
                  </div>

                  <div class="rightTools">
                    <button class="primary" id="btnAddAppt">‚ûï Adicionar</button>
                    <button id="btnAgClear">üßº Limpar</button>
                  </div>

                  <div class="hint">
                    B√¥nus: dias com agendamento aparecem ‚Äúmarcados‚Äù no calend√°rio.
                  </div>
                </div>

                <div class="card" style="margin-top:10px">
                  <h3>Filtro</h3>
                  <div class="row" style="margin-top:10px">
                    <div>
                      <label>Paciente</label>
                      <input id="agFilterPatient" placeholder="Ex.: Maria" />
                    </div>
                    <div>
                      <label>Status</label>
                      <select id="agFilterStatus">
                        <option value="">(todos)</option>
                        <option>Confirmado</option>
                        <option>Pendente</option>
                        <option>Faltou</option>
                        <option>Atendido</option>
                        <option>Remarcado</option>
                      </select>
                    </div>
                  </div>
                  <div style="margin-top:10px">
                    <label>Data (clicando no calend√°rio j√° preenche)</label>
                    <input id="agFilterDate" type="date" />
                  </div>
                  <div class="rightTools">
                    <button id="btnAgApply">üîé Filtrar</button>
                    <button id="btnAgReset">‚Ü©Ô∏è Limpar filtro</button>
                  </div>
                </div>
              </div>

              <div>
                <div class="card">
                  <h3>Lista de agendamentos</h3>
                  <p>Toque num item pra puxar dados para documentos.</p>
                  <div class="hr"></div>
                  <div id="apptList" class="list"></div>
                  <div id="apptEmpty" class="empty" style="display:none">
                    Nenhum agendamento nesse filtro/dia.
                  </div>
                </div>
              </div>

            </div>
          </section>

          <!-- RECEITA -->
          <section id="tab-receita" style="display:none">
            <div class="split">
              <div class="card">
                <h3>Receita (montagem r√°pida)</h3>

                <div class="row" style="margin-top:10px">
                  <div>
                    <label>Paciente</label>
                    <input id="rxPatient" list="patientsList" placeholder="Selecione ou digite" />
                  </div>
                  <div>
                    <label>Data</label>
                    <input id="rxDate" type="date" />
                  </div>
                </div>

                <div class="hr"></div>

                <div class="row">
                  <div>
                    <label>Buscar medicamento salvo</label>
                    <input id="rxMedSearch" placeholder="Digite..." list="medsList" />
                    <datalist id="medsList"></datalist>
                  </div>
                  <div>
                    <label>Qtd/Detalhe extra</label>
                    <input id="rxQty" placeholder="Ex.: 1 caixa" />
                  </div>
                </div>

                <div style="margin-top:10px">
                  <label>Posologia / Modo de uso</label>
                  <input id="rxDose" placeholder="Pode editar" />
                </div>

                <div style="margin-top:10px">
                  <label>Orienta√ß√µes</label>
                  <textarea id="rxNotes" placeholder="Pode editar"></textarea>
                </div>

                <div class="rightTools">
                  <button class="primary" id="btnRxAddItem">‚ûï Adicionar</button>
                  <button id="btnRxClearItem">üßº Limpar item</button>
                </div>

                <div class="hr"></div>

                <label>Observa√ß√µes gerais</label>
                <textarea id="rxGeneral" placeholder="Ex.: retornar em 7 dias..."></textarea>

                <div class="rightTools">
                  <button class="ok" id="btnRxPreview">üëÅÔ∏è Pr√©-visualizar</button>
                  <button class="primary" id="btnRxPrint">üñ®Ô∏è Imprimir/Salvar PDF</button>
                  <button class="danger" id="btnRxReset">üß® Limpar receita</button>
                </div>
              </div>

              <div class="card">
                <h3>Itens da receita</h3>
                <div class="hr"></div>
                <div id="rxItems" class="list"></div>
                <div id="rxEmpty" class="empty" style="display:none">
                  Adicione medicamentos usando a busca.
                </div>
              </div>
            </div>
          </section>

          <!-- FICHA -->
          <section id="tab-ficha" style="display:none">
            <div class="split">
              <div class="card">
                <h3>Ficha cl√≠nica</h3>

                <div class="row" style="margin-top:10px">
                  <div>
                    <label>Paciente</label>
                    <input id="fcPatient" list="patientsList" />
                  </div>
                  <div>
                    <label>Data</label>
                    <input id="fcDate" type="date" />
                  </div>
                </div>

                <div class="row" style="margin-top:10px">
                  <div>
                    <label>Queixa principal</label>
                    <input id="fcChief" />
                  </div>
                  <div>
                    <label>Procedimento / Conduta</label>
                    <input id="fcPlan" />
                  </div>
                </div>

                <div style="margin-top:10px">
                  <label>Anamnese / Hist√≥rico</label>
                  <textarea id="fcHx"></textarea>
                </div>
                <div style="margin-top:10px">
                  <label>Exame cl√≠nico</label>
                  <textarea id="fcExam"></textarea>
                </div>
                <div style="margin-top:10px">
                  <label>Evolu√ß√£o / Observa√ß√µes</label>
                  <textarea id="fcEvol"></textarea>
                </div>

                <div class="rightTools">
                  <button class="primary" id="btnFcSave">üíæ Salvar ficha</button>
                  <button class="ok" id="btnFcPreview">üëÅÔ∏è Pr√©-visualizar</button>
                  <button class="primary" id="btnFcPrint">üñ®Ô∏è Imprimir/Salvar PDF</button>
                  <button class="danger" id="btnFcClear">üß® Limpar</button>
                </div>
              </div>

              <div class="card">
                <h3>Hist√≥rico de fichas</h3>
                <div class="row" style="margin-top:10px">
                  <div>
                    <label>Filtro paciente</label>
                    <input id="fcFilter" placeholder="Ex.: Maria" />
                  </div>
                  <div>
                    <label>&nbsp;</label>
                    <button id="btnFcFilter">üîé Filtrar</button>
                  </div>
                </div>
                <div class="hr"></div>
                <div id="fcList" class="list"></div>
                <div id="fcEmpty" class="empty" style="display:none">Nenhuma ficha salva.</div>
              </div>
            </div>
          </section>

          <!-- ATESTADO -->
          <section id="tab-atestado" style="display:none">
            <div class="split">
              <div class="card">
                <h3>Atestado</h3>

                <div class="row" style="margin-top:10px">
                  <div>
                    <label>Paciente</label>
                    <input id="atPatient" list="patientsList" />
                  </div>
                  <div>
                    <label>Data</label>
                    <input id="atDate" type="date" />
                  </div>
                </div>

                <div class="row" style="margin-top:10px">
                  <div>
                    <label>Dias de afastamento</label>
                    <input id="atDays" type="number" min="0" />
                  </div>
                  <div>
                    <label>Hor√°rio (opcional)</label>
                    <input id="atHours" placeholder="Ex.: 08:00 √†s 12:00" />
                  </div>
                </div>

                <div style="margin-top:10px">
                  <label>Texto do atestado</label>
                  <textarea id="atText" placeholder="Se vazio, uso um texto padr√£o."></textarea>
                </div>

                <div class="rightTools">
                  <button class="ok" id="btnAtPreview">üëÅÔ∏è Pr√©-visualizar</button>
                  <button class="primary" id="btnAtPrint">üñ®Ô∏è Imprimir/Salvar PDF</button>
                  <button class="danger" id="btnAtClear">üß® Limpar</button>
                </div>
              </div>

              <div class="card">
                <h3>Modelo padr√£o</h3>
                <div class="hr"></div>
                <div class="empty">
                  ‚ÄúAtesto para os devidos fins que o(a) paciente acima identificado(a) esteve sob atendimento odontol√≥gico nesta data, necessitando de afastamento pelo per√≠odo informado, a contar de hoje.‚Äù
                </div>
              </div>
            </div>
          </section>

          <!-- OR√áAMENTO -->
          <section id="tab-orcamento" style="display:none">
            <div class="split">
              <div class="card">
                <h3>Or√ßamento</h3>

                <div class="row" style="margin-top:10px">
                  <div>
                    <label>Paciente</label>
                    <input id="orPatient" list="patientsList" />
                  </div>
                  <div>
                    <label>Data</label>
                    <input id="orDate" type="date" />
                  </div>
                </div>

                <div class="row" style="margin-top:10px">
                  <div>
                    <label>Item (procedimento)</label>
                    <input id="orItemName" />
                  </div>
                  <div>
                    <label>Valor (texto)</label>
                    <input id="orItemValue" placeholder="Ex.: R$ 250,00" />
                  </div>
                </div>

                <div class="rightTools" style="margin-top:10px">
                  <button class="primary" id="btnOrAdd">‚ûï Adicionar item</button>
                  <button id="btnOrClearItem">üßº Limpar item</button>
                </div>

                <div style="margin-top:10px">
                  <label>Condi√ß√µes / Observa√ß√µes</label>
                  <textarea id="orNotes"></textarea>
                </div>

                <div class="rightTools">
                  <button class="ok" id="btnOrPreview">üëÅÔ∏è Pr√©-visualizar</button>
                  <button class="primary" id="btnOrPrint">üñ®Ô∏è Imprimir/Salvar PDF</button>
                  <button class="danger" id="btnOrReset">üß® Limpar or√ßamento</button>
                </div>
              </div>

              <div class="card">
                <h3>Itens do or√ßamento</h3>
                <div class="hr"></div>
                <div id="orItems" class="list"></div>
                <div id="orEmpty" class="empty" style="display:none">Adicione itens do or√ßamento.</div>
              </div>
            </div>
          </section>

        </div>
      </main>
    </div>
  </div>

  <!-- PREVIEW/PRINT OVERLAY -->
  <div class="printOverlay" id="printOverlay" role="dialog" aria-modal="true">
    <div class="printShell">
      <div class="printTop">
        <div>
          <strong id="printTitle">Documento</strong>
          <div class="muted" id="printSubtitle">Borda + topo/rodap√©</div>
        </div>
        <div class="mini">
          <button id="btnOverlayPrint" class="primary">üñ®Ô∏è Imprimir/PDF</button>
          <button id="btnOverlayClose">‚úñÔ∏è Fechar</button>
        </div>
      </div>
      <div class="printBody" id="printPreview"></div>
    </div>
  </div>

  <div class="printArea" id="printArea"></div>
  <div class="toast" id="toast"></div>

<script>
/* =======================
   PWA install + SW
======================= */
let deferredPrompt = null;
const btnInstall = document.getElementById("btnInstall");

window.addEventListener("beforeinstallprompt", (e)=>{
  e.preventDefault();
  deferredPrompt = e;
  btnInstall.style.display = "inline-flex";
});

btnInstall.addEventListener("click", async ()=>{
  if(!deferredPrompt) return;
  deferredPrompt.prompt();
  await deferredPrompt.userChoice;
  deferredPrompt = null;
  btnInstall.style.display = "none";
});

if("serviceWorker" in navigator){
  window.addEventListener("load", ()=>{
    navigator.serviceWorker.register("./sw.js").catch(()=>{});
  });
}

/* =======================
   Storage
======================= */
const KEY = "btx_docs_pwa_v2";
const state = loadState();

function loadState(){
  try{
    const raw = localStorage.getItem(KEY);
    if(!raw) return defaultState();
    const s = JSON.parse(raw);
    return Object.assign(defaultState(), s);
  }catch(e){
    return defaultState();
  }
}
function defaultState(){
  return {
    dentist: { name:"", reg:"", phone:"", email:"", addr:"" },
    meds: [],
    patients: [],
    appts: [],
    rxDraft: { patient:"", date:"", items:[], general:"" },
    fichas: [],
    orDraft: { patient:"", date:"", items:[], notes:"" },
    calendar: { year: null, month: null, selectedDate: "" }
  };
}
function saveState(){
  localStorage.setItem(KEY, JSON.stringify(state));
  refreshAll();
}
function uid(prefix="id"){
  return prefix + "_" + Math.random().toString(16).slice(2) + "_" + Date.now().toString(16);
}
function toast(msg){
  const el = document.getElementById("toast");
  el.textContent = msg;
  el.classList.add("show");
  setTimeout(()=>el.classList.remove("show"), 2400);
}

/* =======================
   DOM helpers
======================= */
const $ = (id)=>document.getElementById(id);
function setTodayIfEmpty(inputId){
  const el = $(inputId);
  if(!el.value){
    const d = new Date();
    el.value = d.toISOString().slice(0,10);
  }
}
function safeText(v){ return (v ?? "").toString().trim(); }
function byUpdatedDesc(a,b){ return (b.updatedAt||0) - (a.updatedAt||0); }

/* =======================
   Tabs
======================= */
const tabsEl = $("tabs");
tabsEl.addEventListener("click", (e)=>{
  const t = e.target.closest(".tab");
  if(!t) return;
  document.querySelectorAll(".tab").forEach(x=>x.classList.remove("active"));
  t.classList.add("active");
  showTab(t.dataset.tab);
});
function showTab(name){
  const map = {
    agenda: ["Agenda","Calend√°rio mensal + lista + mem√≥ria"],
    receita: ["Receitu√°rio","Biblioteca de medicamentos + impress√£o"],
    ficha: ["Ficha cl√≠nica","Salva por paciente e hist√≥rico"],
    atestado: ["Atestado","Documento r√°pido e elegante"],
    orcamento: ["Or√ßamento","Itens + condi√ß√µes, organizado"]
  };
  $("viewTitle").textContent = map[name][0];
  $("viewSub").textContent = map[name][1];
  ["agenda","receita","ficha","atestado","orcamento"].forEach(k=>{
    $("tab-"+k).style.display = (k===name) ? "block" : "none";
  });
}

/* =======================
   Dentist binding
======================= */
["dentName","dentReg","dentPhone","dentEmail","dentAddr"].forEach((id, idx)=>{
  const key = ["name","reg","phone","email","addr"][idx];
  const el = $(id);
  el.value = state.dentist[key] || "";
  el.addEventListener("input", ()=>{
    state.dentist[key] = el.value;
    state.dentist.updatedAt = Date.now();
    localStorage.setItem(KEY, JSON.stringify(state));
  });
});

/* =======================
   Meds
======================= */
$("btnAddMed").addEventListener("click", ()=>{
  const name = safeText($("medName").value);
  if(!name) return toast("Digite o nome do medicamento.");
  const form = safeText($("medForm").value);
  const dose = safeText($("medDose").value);
  const notes = safeText($("medNotes").value);

  const existing = state.meds.find(m => m.name.toLowerCase() === name.toLowerCase());
  if(existing){
    existing.form=form; existing.dose=dose; existing.notes=notes; existing.updatedAt=Date.now();
    toast("Medicamento atualizado.");
  }else{
    state.meds.push({ id: uid("med"), name, form, dose, notes, usedCount:0, updatedAt:Date.now() });
    toast("Medicamento salvo.");
  }
  saveState();
  clearMedFields(false);
});
$("btnClearMed").addEventListener("click", ()=>clearMedFields(true));
function clearMedFields(clearAll){
  $("medName").value="";
  if(clearAll){ $("medForm").value=""; $("medDose").value=""; $("medNotes").value=""; }
}

/* =======================
   Patients
======================= */
$("btnSavePatient").addEventListener("click", ()=>{
  const name = safeText($("patName").value);
  if(!name) return toast("Digite o nome do paciente.");
  const doc = safeText($("patDoc").value);
  const birth = $("patBirth").value || "";
  const phone = safeText($("patPhone").value);
  const notes = safeText($("patNotes").value);

  const existing = state.patients.find(p => p.name.toLowerCase() === name.toLowerCase());
  if(existing){
    existing.doc=doc; existing.birth=birth; existing.phone=phone; existing.notes=notes; existing.updatedAt=Date.now();
    toast("Paciente atualizado.");
  }else{
    state.patients.push({ id: uid("pat"), name, doc, birth, phone, notes, updatedAt: Date.now() });
    toast("Paciente salvo.");
  }
  saveState();
});
$("btnClearPatient").addEventListener("click", ()=>{
  ["patName","patDoc","patBirth","patPhone","patNotes"].forEach(id=>$(id).value="");
});

/* =======================
   Calendar Engine (Agenda)
======================= */
const DOW = ["DOM","SEG","TER","QUA","QUI","SEX","S√ÅB"];

function initCalendar(){
  const now = new Date();
  if(state.calendar.year == null) state.calendar.year = now.getFullYear();
  if(state.calendar.month == null) state.calendar.month = now.getMonth(); // 0-11
  if(!state.calendar.selectedDate) state.calendar.selectedDate = now.toISOString().slice(0,10);
  localStorage.setItem(KEY, JSON.stringify(state));
  renderCalendar();
}
function ymd(dateObj){
  return dateObj.toISOString().slice(0,10);
}
function renderCalendar(){
  const year = state.calendar.year;
  const month = state.calendar.month;

  // title
  const monthName = new Date(year, month, 1).toLocaleDateString("pt-BR", { month:"long", year:"numeric" });
  $("calTitle").textContent = monthName.charAt(0).toUpperCase() + monthName.slice(1);

  // dow row
  const dow = $("calDow");
  dow.innerHTML = "";
  DOW.forEach(d=>{
    const el = document.createElement("div");
    el.className = "dow";
    el.textContent = d;
    dow.appendChild(el);
  });

  // build day marks
  const marksByDate = apptMarkIndex();

  const daysWrap = $("calDays");
  daysWrap.innerHTML = "";

  const first = new Date(year, month, 1);
  const startDow = first.getDay();
  const daysInMonth = new Date(year, month+1, 0).getDate();
  const daysPrevMonth = new Date(year, month, 0).getDate();

  const today = new Date();
  const todayStr = today.toISOString().slice(0,10);

  // 6 weeks grid (42 cells)
  for(let i=0;i<42;i++){
    const cell = document.createElement("div");
    cell.className = "day";

    const dayNum = i - startDow + 1;
    let d;
    let inMonth = true;

    if(dayNum <= 0){
      // previous month
      inMonth = false;
      d = new Date(year, month-1, daysPrevMonth + dayNum);
      cell.classList.add("muted");
    }else if(dayNum > daysInMonth){
      // next month
      inMonth = false;
      d = new Date(year, month+1, dayNum - daysInMonth);
      cell.classList.add("muted");
    }else{
      d = new Date(year, month, dayNum);
    }

    const dStr = ymd(d);
    cell.textContent = d.getDate();

    if(dStr === todayStr) cell.classList.add("today");
    if(dStr === state.calendar.selectedDate) cell.classList.add("selected");

    const mark = marksByDate[dStr];
    if(mark){
      const dot = document.createElement("div");
      dot.className = "dot";
      if(mark.bad) dot.classList.add("bad");
      else if(mark.warn) dot.classList.add("warn");
      daysWrap.appendChild(cell);
      cell.appendChild(dot);
    }else{
      daysWrap.appendChild(cell);
    }

    cell.addEventListener("click", ()=>{
      // if clicked on neighbor month, jump month too
      state.calendar.selectedDate = dStr;
      if(!inMonth){
        state.calendar.year = d.getFullYear();
        state.calendar.month = d.getMonth();
      }
      // set filters + date inputs
      $("agDate").value = dStr;
      $("agFilterDate").value = dStr;
      localStorage.setItem(KEY, JSON.stringify(state));
      renderCalendar();
      renderAppts();
    });
  }
}
function apptMarkIndex(){
  // mark day if there are appointments; color if any bad/warn status exists
  const idx = {};
  for(const ap of state.appts){
    const date = ap.date;
    if(!date) continue;
    if(!idx[date]) idx[date] = { warn:false, bad:false };
    const s = (ap.status||"").toLowerCase();
    if(s==="faltou") idx[date].bad = true;
    if(s==="pendente" || s==="remarcado") idx[date].warn = true;
  }
  return idx;
}

$("calPrev").addEventListener("click", ()=>{
  state.calendar.month--;
  if(state.calendar.month < 0){ state.calendar.month = 11; state.calendar.year--; }
  localStorage.setItem(KEY, JSON.stringify(state));
  renderCalendar();
});
$("calNext").addEventListener("click", ()=>{
  state.calendar.month++;
  if(state.calendar.month > 11){ state.calendar.month = 0; state.calendar.year++; }
  localStorage.setItem(KEY, JSON.stringify(state));
  renderCalendar();
});
$("calToday").addEventListener("click", ()=>{
  const now = new Date();
  state.calendar.year = now.getFullYear();
  state.calendar.month = now.getMonth();
  state.calendar.selectedDate = now.toISOString().slice(0,10);
  $("agDate").value = state.calendar.selectedDate;
  $("agFilterDate").value = state.calendar.selectedDate;
  localStorage.setItem(KEY, JSON.stringify(state));
  renderCalendar();
  renderAppts();
});

/* =======================
   Agenda
======================= */
setTodayIfEmpty("agDate");

$("btnAddAppt").addEventListener("click", ()=>{
  const date = $("agDate").value;
  const time = $("agTime").value || "";
  const patient = safeText($("agPatient").value);
  const status = $("agStatus").value;
  const notes = safeText($("agNotes").value);

  if(!date) return toast("Selecione a data.");
  if(!patient) return toast("Informe o paciente.");

  const now = Date.now();
  state.appts.push({ id: uid("appt"), date, time, patient, status, notes, createdAt: now, updatedAt: now });

  const p = state.patients.find(x=>x.name.toLowerCase()===patient.toLowerCase());
  if(p) p.updatedAt = now;
  else state.patients.push({ id: uid("pat"), name: patient, doc:"", birth:"", phone:"", notes:"", updatedAt: now });

  // keep calendar selected on that date
  state.calendar.selectedDate = date;
  const d = new Date(date+"T00:00:00");
  state.calendar.year = d.getFullYear();
  state.calendar.month = d.getMonth();

  saveState();
  toast("Agendamento salvo.");
  $("agNotes").value = "";
});

$("btnAgClear").addEventListener("click", ()=>{
  $("agTime").value = "";
  $("agPatient").value = "";
  $("agNotes").value = "";
  $("agStatus").value = "Confirmado";
});

$("btnAgApply").addEventListener("click", renderAppts);
$("btnAgReset").addEventListener("click", ()=>{
  $("agFilterPatient").value = "";
  $("agFilterStatus").value = "";
  $("agFilterDate").value = "";
  renderAppts();
});

function statusChip(status){
  const s = (status||"").toLowerCase();
  if(s==="confirmado" || s==="atendido") return "ok";
  if(s==="pendente" || s==="remarcado") return "warn";
  if(s==="faltou") return "bad";
  return "";
}

function renderAppts(){
  const list = $("apptList");
  const empty = $("apptEmpty");
  list.innerHTML = "";

  const fp = safeText($("agFilterPatient").value).toLowerCase();
  const fs = $("agFilterStatus").value;
  const fd = $("agFilterDate").value;

  const items = state.appts.slice().sort((a,b)=>{
    const da = (a.date||"") + (a.time||"");
    const db = (b.date||"") + (b.time||"");
    return db.localeCompare(da);
  }).filter(x=>{
    if(fp && !(x.patient||"").toLowerCase().includes(fp)) return false;
    if(fs && x.status!==fs) return false;
    if(fd && x.date!==fd) return false;
    return true;
  });

  empty.style.display = items.length ? "none" : "block";

  items.forEach(ap=>{
    const div = document.createElement("div");
    div.className = "card";
    const chipClass = statusChip(ap.status);
    div.innerHTML = `
      <h3>${escapeHtml(ap.patient || "‚Äî")}</h3>
      <p>${escapeHtml(ap.date || "")} ${escapeHtml(ap.time || "")} ‚Ä¢ ${escapeHtml(ap.notes || "")}</p>
      <div class="mini" style="margin-top:8px">
        <span class="chip ${chipClass}">${escapeHtml(ap.status || "‚Äî")}</span>
        <span class="chip">ID: ${escapeHtml(ap.id.slice(-8))}</span>
      </div>
      <div class="rightTools">
        <button class="primary" data-act="use">üìå Usar nos docs</button>
        <button class="danger" data-act="del">üóëÔ∏è Excluir</button>
      </div>
    `;
    div.querySelector('[data-act="use"]').addEventListener("click", ()=>{
      $("rxPatient").value = ap.patient || "";
      $("fcPatient").value = ap.patient || "";
      $("atPatient").value = ap.patient || "";
      $("orPatient").value = ap.patient || "";
      $("fcChief").value = ap.notes || $("fcChief").value;
      toast("Paciente puxado para os documentos.");
      document.querySelector('.tab[data-tab="receita"]').click();
    });
    div.querySelector('[data-act="del"]').addEventListener("click", ()=>{
      state.appts = state.appts.filter(x=>x.id!==ap.id);
      saveState();
      toast("Agendamento removido.");
    });

    list.appendChild(div);
  });

  // calendar refresh marks
  renderCalendar();
}

/* =======================
   Receitas / Fichas / Atestado / Or√ßamento
   (mesmo n√∫cleo do seu gerador anterior)
======================= */
function escapeHtml(str){
  return (str ?? "").toString()
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}
function getPatient(name){
  const n = safeText(name).toLowerCase();
  return state.patients.find(p => (p.name||"").toLowerCase()===n) || null;
}
function nowStamp(){
  const d = new Date();
  const pad = (x)=> String(x).padStart(2,"0");
  return `${d.toLocaleDateString("pt-BR")} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
}
function docTemplate({title, patientName, dateStr, bodyHtml}){
  const dent = state.dentist || {};
  const p = getPatient(patientName) || {name: patientName||"", doc:"", birth:"", phone:""};
  const addr = safeText(dent.addr) || "Endere√ßo do profissional (configure na lateral).";
  const stampRight = `${escapeHtml(dateStr || "")}<br><span class="muted">Gerado: ${escapeHtml(nowStamp())}</span>`;

  return `
    <div class="docPage">
      <div class="docHeader">
        <div class="topRow">
          <div class="dent">
            ${escapeHtml(dent.name || "Nome do dentista")}
            <small>${escapeHtml(dent.reg || "CRO/Registro")} ‚Ä¢ ${escapeHtml(dent.phone || "Telefone")} ‚Ä¢ ${escapeHtml(dent.email || "E-mail")}</small>
          </div>
          <div class="stamp">
            <b>${escapeHtml(title)}</b><br>
            ${stampRight}
          </div>
        </div>

        <div class="pat">
          <div><b>Paciente</b>${escapeHtml(p.name || "‚Äî")}</div>
          <div><b>Documento</b>${escapeHtml(p.doc || "‚Äî")}</div>
          <div><b>Nascimento</b>${escapeHtml(p.birth || "‚Äî")}</div>
          <div><b>Telefone</b>${escapeHtml(p.phone || "‚Äî")}</div>
          <div style="grid-column: span 2"><b>Obs.</b>${escapeHtml((p.notes||"").slice(0,120) || "‚Äî")}</div>
        </div>
      </div>

      <div class="docMain">
        <h3>${escapeHtml(title)}</h3>
        ${bodyHtml}
      </div>

      <div class="docFooter">
        <div class="footGrid">
          <div class="addr"><b>Endere√ßo/Contato</b><br>${escapeHtml(addr).replace(/\n/g,"<br>")}</div>
          <div class="sig">
            <div class="line"></div>
            Assinatura e carimbo
          </div>
        </div>
      </div>
    </div>
  `;
}

const overlay = $("printOverlay");
$("btnOverlayClose").addEventListener("click", ()=>overlay.classList.remove("show"));
$("btnOverlayPrint").addEventListener("click", ()=>printNow($("printPreview").innerHTML));
function openPreview(html){
  $("printPreview").innerHTML = html;
  overlay.classList.add("show");
}
function printNow(html){
  $("printArea").innerHTML = html;
  overlay.classList.remove("show");
  setTimeout(()=>window.print(), 50);
}

/* ===== Receita ===== */
setTodayIfEmpty("rxDate");
$("rxMedSearch").addEventListener("input", ()=>{
  const q = safeText($("rxMedSearch").value).toLowerCase();
  const m = state.meds.find(x=>x.name.toLowerCase()===q);
  if(m){ $("rxDose").value = m.dose || ""; $("rxNotes").value = m.notes || ""; }
});
$("btnRxAddItem").addEventListener("click", ()=>{
  const medName = safeText($("rxMedSearch").value);
  if(!medName) return toast("Escolha/digite um medicamento.");
  const dose = safeText($("rxDose").value);
  const notes = safeText($("rxNotes").value);
  const qty = safeText($("rxQty").value);

  state.rxDraft.patient = safeText($("rxPatient").value);
  state.rxDraft.date = $("rxDate").value || "";
  state.rxDraft.general = safeText($("rxGeneral").value);
  state.rxDraft.items.push({ id: uid("rxitem"), medName, dose, notes, qty });

  const m = state.meds.find(x=>x.name.toLowerCase()===medName.toLowerCase());
  if(m){ m.usedCount = (m.usedCount||0)+1; m.updatedAt = Date.now(); }

  saveState();
  toast("Item adicionado.");
  $("rxMedSearch").value=""; $("rxQty").value=""; $("rxDose").value=""; $("rxNotes").value="";
});
$("btnRxClearItem").addEventListener("click", ()=>{
  $("rxMedSearch").value=""; $("rxQty").value=""; $("rxDose").value=""; $("rxNotes").value="";
});
$("btnRxReset").addEventListener("click", ()=>{
  state.rxDraft = { patient:"", date:"", items:[], general:"" };
  $("rxPatient").value=""; setTodayIfEmpty("rxDate"); $("rxGeneral").value="";
  saveState(); toast("Receita limpa.");
});
$("btnRxPreview").addEventListener("click", ()=>openPreview(buildRxDoc()));
$("btnRxPrint").addEventListener("click", ()=>printNow(buildRxDoc()));

function buildRxDoc(){
  const patient = safeText($("rxPatient").value) || state.rxDraft.patient;
  const date = $("rxDate").value || state.rxDraft.date || "";
  const general = safeText($("rxGeneral").value) || state.rxDraft.general || "";
  const items = state.rxDraft.items || [];

  const body = `
    <div class="block">
      <h4>Prescri√ß√£o</h4>
      ${items.length ? items.map((it, idx)=>`
        <p><b>${idx+1}.</b> ${escapeHtml(it.medName)}${it.qty?` <span class="muted">(${escapeHtml(it.qty)})</span>`:""}
${it.dose?`\n<b>Uso:</b> ${escapeHtml(it.dose)}`:""}
${it.notes?`\n<b>Orienta√ß√µes:</b> ${escapeHtml(it.notes)}`:""}</p>
        <div style="height:8px"></div>
      `).join("") : `<p class="muted">Nenhum item adicionado.</p>`}
    </div>
    ${general ? `<div class="block"><h4>Observa√ß√µes gerais</h4><p>${escapeHtml(general)}</p></div>` : ""}
  `;
  return docTemplate({title:"Receitu√°rio", patientName: patient, dateStr: date, bodyHtml: body});
}

/* ===== Ficha ===== */
setTodayIfEmpty("fcDate");
$("btnFcSave").addEventListener("click", ()=>{
  const patient = safeText($("fcPatient").value);
  const date = $("fcDate").value || "";
  if(!patient) return toast("Selecione/digite o paciente.");
  if(!date) return toast("Selecione a data.");

  state.fichas.unshift({
    id: uid("fc"),
    patient, date,
    chief: safeText($("fcChief").value),
    plan: safeText($("fcPlan").value),
    hx: safeText($("fcHx").value),
    exam: safeText($("fcExam").value),
    evol: safeText($("fcEvol").value),
    createdAt: Date.now()
  });
  saveState();
  toast("Ficha salva.");
});
$("btnFcPreview").addEventListener("click", ()=>openPreview(buildFichaDoc()));
$("btnFcPrint").addEventListener("click", ()=>printNow(buildFichaDoc()));
$("btnFcClear").addEventListener("click", ()=>{
  ["fcPatient","fcChief","fcPlan","fcHx","fcExam","fcEvol"].forEach(id=>$(id).value="");
  setTodayIfEmpty("fcDate");
});
$("btnFcFilter").addEventListener("click", renderFichas);

function buildFichaDoc(){
  const patient = safeText($("fcPatient").value);
  const date = $("fcDate").value || "";
  const body = `
    <div class="block"><h4>Queixa principal</h4><p>${escapeHtml($("fcChief").value || "‚Äî")}</p></div>
    <div class="block"><h4>Procedimento / Conduta</h4><p>${escapeHtml($("fcPlan").value || "‚Äî")}</p></div>
    <div class="block"><h4>Anamnese / Hist√≥rico</h4><p>${escapeHtml($("fcHx").value || "‚Äî")}</p></div>
    <div class="block"><h4>Exame cl√≠nico</h4><p>${escapeHtml($("fcExam").value || "‚Äî")}</p></div>
    <div class="block"><h4>Evolu√ß√£o / Observa√ß√µes</h4><p>${escapeHtml($("fcEvol").value || "‚Äî")}</p></div>
  `;
  return docTemplate({title:"Ficha Cl√≠nica", patientName: patient, dateStr: date, bodyHtml: body});
}

/* ===== Atestado ===== */
setTodayIfEmpty("atDate");
$("btnAtPreview").addEventListener("click", ()=>openPreview(buildAtestadoDoc()));
$("btnAtPrint").addEventListener("click", ()=>printNow(buildAtestadoDoc()));
$("btnAtClear").addEventListener("click", ()=>{
  ["atPatient","atDays","atHours","atText"].forEach(id=>$(id).value="");
  setTodayIfEmpty("atDate");
});

function buildAtestadoDoc(){
  const patient = safeText($("atPatient").value);
  const date = $("atDate").value || "";
  const days = safeText($("atDays").value);
  const hours = safeText($("atHours").value);
  let text = safeText($("atText").value);
  if(!text){
    text = "Atesto para os devidos fins que o(a) paciente acima identificado(a) esteve sob atendimento odontol√≥gico nesta data, necessitando de afastamento de suas atividades pelo per√≠odo informado, a contar de hoje.";
  }
  const details = [];
  if(days) details.push(`<p><b>Per√≠odo:</b> ${escapeHtml(days)} dia(s).</p>`);
  if(hours) details.push(`<p><b>Hor√°rio:</b> ${escapeHtml(hours)}.</p>`);
  const body = `<div class="block"><h4>Declara√ß√£o</h4><p>${escapeHtml(text)}</p>${details.join("")}</div>`;
  return docTemplate({title:"Atestado", patientName: patient, dateStr: date, bodyHtml: body});
}

/* ===== Or√ßamento ===== */
setTodayIfEmpty("orDate");
$("btnOrAdd").addEventListener("click", ()=>{
  const name = safeText($("orItemName").value);
  const value = safeText($("orItemValue").value);
  if(!name) return toast("Digite o item do or√ßamento.");
  state.orDraft.patient = safeText($("orPatient").value);
  state.orDraft.date = $("orDate").value || "";
  state.orDraft.notes = safeText($("orNotes").value);
  state.orDraft.items.push({ id: uid("oritem"), name, value });
  saveState();
  toast("Item adicionado.");
  $("orItemName").value=""; $("orItemValue").value="";
});
$("btnOrClearItem").addEventListener("click", ()=>{ $("orItemName").value=""; $("orItemValue").value=""; });
$("btnOrReset").addEventListener("click", ()=>{
  state.orDraft = { patient:"", date:"", items:[], notes:"" };
  $("orPatient").value=""; $("orNotes").value=""; setTodayIfEmpty("orDate");
  saveState(); toast("Or√ßamento limpo.");
});
$("btnOrPreview").addEventListener("click", ()=>openPreview(buildOrcDoc()));
$("btnOrPrint").addEventListener("click", ()=>printNow(buildOrcDoc()));

function buildOrcDoc(){
  const patient = safeText($("orPatient").value) || state.orDraft.patient;
  const date = $("orDate").value || state.orDraft.date || "";
  const notes = safeText($("orNotes").value) || state.orDraft.notes || "";
  const items = state.orDraft.items || [];
  const body = `
    <div class="block">
      <h4>Itens</h4>
      ${items.length ? items.map((it, idx)=>`<p><b>${idx+1}.</b> ${escapeHtml(it.name)} ‚Äî <b>${escapeHtml(it.value || "‚Äî")}</b></p>`).join("") : `<p class="muted">Nenhum item adicionado.</p>`}
    </div>
    ${notes ? `<div class="block"><h4>Condi√ß√µes / Observa√ß√µes</h4><p>${escapeHtml(notes)}</p></div>` : ""}
  `;
  return docTemplate({title:"Or√ßamento", patientName: patient, dateStr: date, bodyHtml: body});
}

/* =======================
   Renderers
======================= */
function refreshAll(){
  renderPatientsDatalist();
  renderMedsDatalist();
  renderAppts();
  renderRxItems();
  renderFichas();
  renderOrItems();
}

function renderPatientsDatalist(){
  const dl = $("patientsList");
  dl.innerHTML = "";
  state.patients.slice().sort(byUpdatedDesc).forEach(p=>{
    const opt = document.createElement("option");
    opt.value = p.name;
    dl.appendChild(opt);
  });
}

function renderMedsDatalist(){
  const dl = $("medsList");
  dl.innerHTML = "";
  state.meds.slice()
    .sort((a,b)=> (b.usedCount||0)-(a.usedCount||0) || (b.updatedAt||0)-(a.updatedAt||0))
    .forEach(m=>{
      const opt = document.createElement("option");
      opt.value = m.name;
      dl.appendChild(opt);
    });
}

function renderRxItems(){
  const list = $("rxItems");
  const empty = $("rxEmpty");
  list.innerHTML = "";
  const items = state.rxDraft.items || [];
  empty.style.display = items.length ? "none" : "block";
  items.forEach(it=>{
    const div = document.createElement("div");
    div.className = "card";
    div.innerHTML = `
      <h3>${escapeHtml(it.medName)}</h3>
      <p><b>Uso:</b> ${escapeHtml(it.dose || "‚Äî")}</p>
      <p><b>Qtd:</b> ${escapeHtml(it.qty || "‚Äî")}</p>
      <p class="small">${escapeHtml(it.notes || "")}</p>
      <div class="rightTools">
        <button class="danger" data-act="del">üóëÔ∏è Remover</button>
      </div>
    `;
    div.querySelector('[data-act="del"]').addEventListener("click", ()=>{
      state.rxDraft.items = state.rxDraft.items.filter(x=>x.id!==it.id);
      saveState();
      toast("Item removido.");
    });
    list.appendChild(div);
  });
}

function renderFichas(){
  const list = $("fcList");
  const empty = $("fcEmpty");
  list.innerHTML = "";
  const q = safeText($("fcFilter").value).toLowerCase();
  const items = state.fichas.filter(f=> !q || (f.patient||"").toLowerCase().includes(q));
  empty.style.display = items.length ? "none" : "block";

  items.slice(0,30).forEach(f=>{
    const div = document.createElement("div");
    div.className = "card";
    div.innerHTML = `
      <h3>${escapeHtml(f.patient)} <span class="chip">${escapeHtml(f.date||"")}</span></h3>
      <p><b>Queixa:</b> ${escapeHtml(f.chief||"‚Äî")}</p>
      <p class="small"><b>Conduta:</b> ${escapeHtml(f.plan||"‚Äî")}</p>
      <div class="rightTools">
        <button class="primary" data-act="load">üìå Carregar</button>
        <button class="danger" data-act="del">üóëÔ∏è Excluir</button>
      </div>
    `;
    div.querySelector('[data-act="load"]').addEventListener("click", ()=>{
      $("fcPatient").value = f.patient||"";
      $("fcDate").value = f.date||"";
      $("fcChief").value = f.chief||"";
      $("fcPlan").value = f.plan||"";
      $("fcHx").value = f.hx||"";
      $("fcExam").value = f.exam||"";
      $("fcEvol").value = f.evol||"";
      toast("Ficha carregada.");
    });
    div.querySelector('[data-act="del"]').addEventListener("click", ()=>{
      state.fichas = state.fichas.filter(x=>x.id!==f.id);
      saveState();
      toast("Ficha removida.");
    });
    list.appendChild(div);
  });
}

function renderOrItems(){
  const list = $("orItems");
  const empty = $("orEmpty");
  list.innerHTML = "";
  const items = state.orDraft.items || [];
  empty.style.display = items.length ? "none" : "block";
  items.forEach(it=>{
    const div = document.createElement("div");
    div.className = "card";
    div.innerHTML = `
      <h3>${escapeHtml(it.name)}</h3>
      <p class="small"><b>Valor:</b> ${escapeHtml(it.value || "‚Äî")}</p>
      <div class="rightTools">
        <button class="danger" data-act="del">üóëÔ∏è Remover</button>
      </div>
    `;
    div.querySelector('[data-act="del"]').addEventListener("click", ()=>{
      state.orDraft.items = state.orDraft.items.filter(x=>x.id!==it.id);
      saveState();
      toast("Item removido.");
    });
    list.appendChild(div);
  });
}

/* =======================
   Draft sync
======================= */
function hydrateDrafts(){
  $("rxPatient").value = state.rxDraft.patient || "";
  if(state.rxDraft.date) $("rxDate").value = state.rxDraft.date;
  $("rxGeneral").value = state.rxDraft.general || "";

  $("orPatient").value = state.orDraft.patient || "";
  if(state.orDraft.date) $("orDate").value = state.orDraft.date;
  $("orNotes").value = state.orDraft.notes || "";

  // calendar selected date into filters
  if(state.calendar.selectedDate){
    $("agFilterDate").value = state.calendar.selectedDate;
    $("agDate").value = $("agDate").value || state.calendar.selectedDate;
  }
}
["rxPatient","rxDate","rxGeneral"].forEach(id=>{
  $(id).addEventListener("input", ()=>{
    state.rxDraft.patient = safeText($("rxPatient").value);
    state.rxDraft.date = $("rxDate").value || "";
    state.rxDraft.general = safeText($("rxGeneral").value);
    localStorage.setItem(KEY, JSON.stringify(state));
  });
});
["orPatient","orDate","orNotes"].forEach(id=>{
  $(id).addEventListener("input", ()=>{
    state.orDraft.patient = safeText($("orPatient").value);
    state.orDraft.date = $("orDate").value || "";
    state.orDraft.notes = safeText($("orNotes").value);
    localStorage.setItem(KEY, JSON.stringify(state));
  });
});

/* =======================
   Backup / Reset / Quick print
======================= */
$("btnBackup").addEventListener("click", ()=>{
  const data = JSON.stringify(state, null, 2);
  const blob = new Blob([data], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = `btx-docs-backup-${new Date().toISOString().slice(0,10)}.json`;
  a.click();
  URL.revokeObjectURL(url);
  toast("Backup exportado.");
});

$("backupFile").addEventListener("change", async (e)=>{
  const f = e.target.files?.[0];
  if(!f) return;
  try{
    const text = await f.text();
    const obj = JSON.parse(text);
    if(!obj || typeof obj !== "object") throw new Error("inv√°lido");
    Object.assign(state, defaultState(), obj);
    saveState();
    toast("Backup importado.");
  }catch(err){
    toast("Falha ao importar backup (JSON inv√°lido).");
  }finally{
    e.target.value = "";
  }
});

$("btnReset").addEventListener("click", ()=>{
  const ok = confirm("Tem certeza que quer zerar TUDO?");
  if(!ok) return;
  localStorage.removeItem(KEY);
  location.reload();
});

$("btnQuickPrint").addEventListener("click", ()=>{
  const active = document.querySelector(".tab.active")?.dataset?.tab || "agenda";
  if(active==="receita") return printNow(buildRxDoc());
  if(active==="ficha") return printNow(buildFichaDoc());
  if(active==="atestado") return printNow(buildAtestadoDoc());
  if(active==="orcamento") return printNow(buildOrcDoc());
  toast("Pra imprimir: abra Receita/Ficha/Atestado/Or√ßamento.");
});

/* =======================
   Init
======================= */
hydrateDrafts();
refreshAll();
initCalendar();
renderAppts(); // ensures calendar dots show
</script>
</body>
</html>
